<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="main.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>    

    <title>CSC 642 848 Fall 2021 Individual Assignment Cameron Robinson Data survey form</title>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer></script>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="exclamation-triangle-fill" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
        </symbol>
      </svg>
</head>
<body class="container">
<header>
</header>
<br>
<div style="text-align: center;">
    <h4>CSC 642 848 Fall 2021 Individual Assignment Cameron Robinson</h4>
    <h4>Data survey Form</h4>
</div>
<br>
<form id="data_form" action="results.html" class="form-validation"  novalidate>
    <div>
        <label for="AboutUser" class="col-form-label">About You</label>
        <div id="AboutUser" class="grouping">
            
            <div class="col-md-6 needs-validation">
                <label for="firstName" class="col-form-label">First Name <abbr class="required" title="required">*</abbr></label>
                <input type="text" id="firstName" class="form-control check-validity-event" placeholder="John" pattern="[a-zA-Z]{1,40}" required>
                <div class="invalid-feedback">
                    Please enter a valid first name.
                </div>
            </div>

            <div class="col-md-6 needs-validation">
                <label for="lastName" class="col-form-label">Last Name <abbr class="required" title="required">*</abbr></label>
                <input type="text" id="lastName" class="form-control check-validity-event" placeholder="Doe" pattern="[a-zA-Z]{1,40}" required>
                <div class="invalid-feedback">
                    Please enter a valid last name.
                </div>
            </div>
            
            <div class="col-md-2 needs-validation">
                <label for="preferredTitle" class="col-form-label">Preferred Title <abbr class="required" title="required">*</abbr></label>
                <select id="preferredTitle" class="form-select check-validity-event" aria-label="Preferred Title" required>
                    <option selected value="">Select One</option>
                    <option value="None">None</option>
                    <option value="Student">Student</option>
                    <option value="Professor">Professor</option>
                    <option value="Staff">Staff</option>
                    <option value="Retired">Retired</option>
                </select>
                <div class="invalid-feedback">
                    Please select an option.
                </div>
            </div>

            <label for="userHeight" class="col-form-label">Your Height</label>
            <div id="userHeight" class="row g-2 align-items-center">
                <div class="col-auto">
                    <select id="heightFeet" class="form-select" aria-label="Height in feet">
                        <option selected value="">Feet</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                    </select>
                </div>
                <div class="col-auto">
                    <select id="heightInches" class="form-select"  aria-label="Height in inches">
                        <option selected value="">Inches</option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                    </select>
                </div>
                <div id="userHeight-invalid-feedback" class="invalid-feedback">
                    Please select both fields.
                </div>
            </div>

            <div class="col-md-3">
                <label for="phoneNumber" class="col-form-label">Phone Number</label>
                <input type="tel" id="phoneNumber" class="form-control optional-check-validity-event" pattern="^(\((?:[1-9][0-9]{2})\)|[1-9][0-9]{2})(\s|-)?[1-9][0-9]{2}(\s|-)?\d{4}\s*$" placeholder="(555) 555-5555">                
                <div id="phone-number-invalid-feedback" class="invalid-feedback">
                    Please enter a valid phone number.
                </div>
            </div>
        </div>

        <br>

        <label class="col-form-label">Address</label>
        <div class="grouping">
            <div class="col-md-6 needs-validation">
                <label for="address1" class="col-form-label">Address Line 1 <abbr class="required" title="required">*</abbr></label>
                <input type="text" class="form-control check-validity-event" id="address1" placeholder="1234 Doe Street" pattern="[a-zA-Z0-9\s]{1,40}" required>
                <div class="invalid-feedback">
                    Please enter a valid address.
                </div>
            </div>
            <div class="col-md-6">
                <label for="address2" class="col-form-label">Address Line 2</label>
                <input type="text" class="form-control optional-check-validity-event" id="address2" placeholder="Apt 123 (Optional)" pattern="[a-zA-Z0-9\s]{1,40}">                
                <div class="invalid-feedback">
                    Address 2 line is too long
                </div>
            </div>
            <div class="col-md-2 needs-validation">
                <label for="zipCode" class="col-form-label">Zip <abbr class="required" title="required">*</abbr></label>
                <input type="text" class="form-control check-validity-event" id="zipCode" pattern="[0-9]{5}" required>
                <div class="invalid-feedback">
                    Please enter a valid zip code.
                </div>
            </div>
        </div>

        <br>

        <label class="col-form-label">Service Options</label>
        <div class="grouping">
                
            <div>
                <label class="col-form-label">Services Required (Check all that apply)</label>
            </div>

            <input type="checkbox" id="email" name="e-mail" value="E-Mail">
            <label for="email">E-Mail</label><br>
            <input type="checkbox" id="phone" name="phone" value="Phone">
            <label for="phone">Phone</label><br>
            <input type="checkbox" id="facebook" name="Facebook" value="Facebook">
            <label for="facebook">Facebook</label><br>
            <input type="checkbox" id="twitter" name="Twitter" value="Twitter">
            <label for="twitter">Twitter</label><br>
            <input type="checkbox" id="surfaceMail" name="surface mail" value="Surface Mail">
            <label for="surfaceMail">Surface Mail</label><br>
            <input type="checkbox" id="personalVisit" name="personal visit" value="Personal Visit">
            <label for="personalVisit">Personal Visit</label>

            <div class="col-md-4">
                <hr>
            </div>


            <div>
                <label for="" class="col-form-label">Monthly Budget (Select one)</label>
            </div>

            <input type="radio" id="lt50" name="budget" value="lt50">
            <label for="lt50">Less than $50</label><br>
            <input type="radio" id="50-100" name="budget" value="50-100">
            <label for="50-100">$50 - $100</label><br>
            <input type="radio" id="gt100" name="budget" value="gt100">
            <label for="gt100">$100 or More</label>
        </div>

        <br>

        <div class="grouping">
            <div class="col-md-6 needs-validation">
                <label for="emailAddress" class="col-form-label">E-Mail Address <abbr class="required" title="required">*</abbr></label>
                <input type="email" id="emailAddress" class="form-control check-validity-event" placeholder="johndoe@mail.com" required> 
                <div class="invalid-feedback">
                    Please enter a valid e-mail address.
                </div>
            </div>
        </div>
        <br>

        <div class="col-12">
            <div class="col-form-check needs-validation">
                <input class="form-check-input" type="checkbox" value="" id="termsAndConditions" required>
                <label class="form-check-label" for="termsAndConditions">
                I have read and agree to the website <abbr class="dummyLink" title="Dummy link">terms and conditions</abbr> <abbr class="required" title="required">*</abbr>
                </label>
                <div class="invalid-feedback">
                You must agree before submitting.
                </div>
            </div>
        </div>

        <br>

            <div id='html_element'></div>
            <div id="captcha-invalid-feedback" class="invalid-feedback">
                Please confirm you are not a robot.
            </div>

        <br>
        <div class="alert alert-warning fade show visually-hidden" role="alert">
            <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Warning:"><use xlink:href="#exclamation-triangle-fill"/></svg>
            Please fill out all required fields above.
        </div>
        <div class="col-12">
        <input class="btn btn-primary" type="button" value="Submit" onclick="submitForm()">
        </div>
    </div>
</form>
<br>
<br>
<br>

<main>
</main>

<footer>
</footer>

<script>
var captchaValid = false;
var captchaFeedbackDiv = null
let checkPhoneNumberInput = null
let checkHeightInput = null
let validationDivs = null

var onloadCallback = function() {
        grecaptcha.render('html_element', {
            'sitekey' : '6LcODA4dAAAAAElzLcFHQwAw2ExVoo3wIzuCxmHg',
            'callback' : correctCaptcha
        });
    };

var correctCaptcha = function(response) {
    captchaValid = true;
    if(captchaFeedbackDiv !== null) {
        captchaFeedbackDiv.style.display = "none"
    }
};

// Github was allowing the posting of forms but for some reason it stopped working
// towards the end of the project. To fix this issue I changed to "submitting" the
// form with this method and then swapping the page manually.
function submitForm() {
    let submitting = formSubmissionCheck()
    if(submitting) {
        window.location.href = 'results.html'        
    }
    else {
        let alertList = document.querySelectorAll('.alert')
        alertList.forEach(function (alert) {
            alert.classList.remove("visually-hidden")
        })
        window.scrollTo(0, document.body.scrollHeight)
    }
}

function saveFormToStorage(form) {
    sessionStorage.setItem("firstName",       document.getElementById("firstName").value)
    sessionStorage.setItem("lastName",        document.getElementById("lastName").value)
    sessionStorage.setItem("emailAddress",    document.getElementById("emailAddress").value)
    sessionStorage.setItem("preferredTitle",  document.getElementById("preferredTitle").value)
    sessionStorage.setItem("heightFeet",      document.getElementById("heightFeet").value)
    sessionStorage.setItem("heightInches",    document.getElementById("heightInches").value)
    sessionStorage.setItem("phoneNumber",     document.getElementById("phoneNumber").value)
    sessionStorage.setItem("address1",        document.getElementById("address1").value)
    sessionStorage.setItem("address2",        document.getElementById("address2").value)
    sessionStorage.setItem("zipCode",         document.getElementById("zipCode").value)

    let serivces = [];
    
    let email = document.getElementById("email")
    if(email.checked) {
        serivces.push(email.value)
    }

    let phone = document.getElementById("phone")
    if(phone.checked) {
        serivces.push(phone.value)
    }

    let facebook = document.getElementById("facebook")
    if(facebook.checked) {
        serivces.push(facebook.value)
    }

    let twitter = document.getElementById("twitter")
    if(twitter.checked) {
        serivces.push(twitter.value)
    }

    let surfaceMail = document.getElementById("surfaceMail")
    if(surfaceMail.checked) {
        serivces.push(surfaceMail.value)
    }

    let personalVisit = document.getElementById("personalVisit")
    if(personalVisit.checked) {
        serivces.push(personalVisit.value)
    }

    sessionStorage.setItem("services", JSON.stringify(serivces))

    let budget = "Not Supplied";
    if(document.getElementById("lt50").checked) {
        budget = "Less than $50"
    }
    else if(document.getElementById("50-100").checked) {
        budget = "$50 - $100"
    }
    else if(document.getElementById("gt100").checked) {
        budget = "$100 or More"
    }
    sessionStorage.setItem("budget", budget)
}

// This was the original function used to check and stop the propogation of 
// form submission when there were errors in the data. Now used when called
// from the submit form button.
function formSubmissionCheck() {

    let form = document.getElementById('data_form')
    let submitting = true
    // If any one of the fields is invalid we stop the event.
    if (form.checkValidity() === false) {
        event.preventDefault()
        event.stopPropagation()
        submitting = false
    }
    
    if(captchaValid === false) {
        event.preventDefault()
        event.stopPropagation()

        captchaFeedbackDiv.style.display = "block"
        submitting = false;
    }

    // Check validity of phone number and height, stop the submission
    // if needed.
    let phoneValid = checkPhoneNumberInput()
    let heightValid = checkHeightInput()
    if(phoneValid || heightValid ) {
        event.preventDefault()
        event.stopPropagation()
        submitting = false;
    }

    if(submitting) {

        saveFormToStorage(form)
    }
    else {
        // We are not switching to the results page so update the 
        // divs to show which fields have errors.
        // For each required field we set its css tag to allow
        // for the bootstrap popups.
        console.log("TEST")
        validationDivs.forEach(function (div) {
            div.classList.add('was-validated')
        })
    }

    return submitting;
}

function setValidatorEvents() {

    let check_validity_inputs = document.querySelectorAll('.check-validity-event')
    check_validity_inputs = Array.from(check_validity_inputs)
    for(let input of check_validity_inputs) {

        input.addEventListener('change', (event) => {

            input.parentNode.classList.add('was-validated')
        })
    }

    let optional_validity_inputs = document.querySelectorAll('.optional-check-validity-event')
    optional_validity_inputs = Array.from(optional_validity_inputs)
    for(let input of optional_validity_inputs) {

        input.addEventListener('change', (event) => {

            if(input.checkValidity() === false || input.value !== "") {

                input.parentNode.classList.add('was-validated')
            }
            else {

                if(input.value === "") {
                    input.parentNode.classList.remove('was-validated')
                }
            }
        })
    }
}

// Basis of this function was taken from https://getbootstrap.com/docs/5.0/forms/validation/
// but modified for my purposes.
(function () {
    'use strict'

    // Get a list of all the divs that need validation. This is used to apply 
    // the special bootstrap validation popups only on required fields.
    validationDivs = document.querySelectorAll('.needs-validation')
    validationDivs = Array.from(validationDivs)

    setValidatorEvents()

    // Get the invalid feedback error div for the captcha. Used to
    // display the error on form submission but can not be done through standard
    // bootstrap due to limitations with system.
    captchaFeedbackDiv = document.getElementById('captcha-invalid-feedback')

    // Get the phone number input field and invalid feedback div. Used to display
    // the error on form submission but because it is an optional value
    // do not want it to be displayed at all times. This will only appear 
    // if the form has data that does not fit the required type.
    let phoneNumberFeedback = document.getElementById('phone-number-invalid-feedback')
    let phoneNumberInput = document.getElementById('phoneNumber')

    // Creating phone number error closure.
    checkPhoneNumberInput = () => {

        let valid = true
        if(phoneNumberInput.checkValidity() === false) {
            phoneNumberFeedback.style.display = "block"
        }
        else {
            phoneNumberFeedback.style.display = "none"
            valid = false
        }

        return valid
    }

    // Update the phone number error when the input field is changed.
    phoneNumberInput.addEventListener('change', (event) => {
        checkPhoneNumberInput()
    })

    // Get fields to check for proper height input.
    let heightFeedback = document.getElementById("userHeight-invalid-feedback")
    let heightFeet = document.getElementById("heightFeet")
    let heightInches = document.getElementById("heightInches")

    // Create closure in order to validate height and display error if needed.
    checkHeightInput = () => {

        let valid = true
        if((heightFeet.value !== "" && heightInches.value === "") || 
           (heightFeet.value === "" && heightInches.value !== "")) {
            heightFeedback.style.display = "block"
        }
        else {
            heightFeedback.style.display = "none"
            valid = false
        }

        return valid
    }

    // Set up callbacks on the fields chaning in order to display error.
    heightFeet.addEventListener('change', (event) => {
        checkHeightInput()
    })
    heightInches.addEventListener('change', (event) => {
        checkHeightInput()
    })

    // Add an event listener so the first time a title is selected we remove the
    // empty option because it is a required field. Still allows for updating
    // the selection if a mistake is made.
    let prefTitleSelector = document.getElementById("preferredTitle")
    let removedFirst = false
    prefTitleSelector.addEventListener('change', (event) => {

        // We want to only let this run once
        if(removedFirst === false) {
            prefTitleSelector.remove(0); 
            removedFirst = true
        }
    })

    // Fetch all the forms that need validation
    var forms = document.querySelectorAll('.form-validation')

    // Loop over the forms and prevent submission if fields are invalid
    //
    // This is not possible to use with github pages from what I can tell
    // I had to rework the page submission in order to use a basic button 
    // rather then attempting to post the form.
    Array.from(forms).forEach(function (form) {

        form.addEventListener('submit', formSubmissionCheck, false)
    })
})()
</script>
</body>
</html>